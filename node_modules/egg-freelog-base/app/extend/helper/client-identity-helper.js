'use strict'

const moment = require('moment')
const cryptoHelper = require('./helper/crypto_helper')

module.exports = {

    /**
     * 生成client认证头信息
     * @param clientInfo
     * @param identityInfo
     */
    generateClientHeader(app, identityInfo) {

        const {clientCredentialInfo} = app.config
        if (!clientCredentialInfo) {
            throw Error('未找到clientCredentialInfo配置信息')
        }

        const header = {
            clientId: clientCredentialInfo.clientId,
            timeLine: moment().format('X')
        }

        const text = `${URL.parse(url).path}&timeline=${header.timeLine}`
        header.sign = cryptoHelper.hmacSha1(text, clientCredentialInfo.privateKey)

        if (identityInfo && Object.keys(identityInfo).length) {
            const identityToken = cryptoHelper.base64Encode(JSON.stringify(identityInfo))
            const identityTokenSign = cryptoHelper.hmacSha1(identityToken, clientCredentialInfo.privateKey)
            header.authentication = `${identityToken}.${identityTokenSign}`
        }

        return header
    }
}