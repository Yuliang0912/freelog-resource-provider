'use strict'

const JwtHelper = require('../extend/helper/jwt_helper')
const jwtClass = new JwtHelper()

module.exports = (options, app) => async (ctx, next) => {

    ctx.request.identityInfo = ctx.request.identityInfo || {}

    let jwtStr = ctx.cookies.get('authInfo', {signed: false})
    if (!jwtStr) {
        let auth = ctx.headers.authorization || ''
        auth.startsWith('Bearer ') && (jwtStr = auth.replace('Bearer ', ''))
    }

    if (!jwtStr) {
        await next()
        return
    }

    jwtClass.publicKey = app.config.jwtAuth.publicKey

    let verifyResult = jwtClass.verifyJwt(jwtStr)

    if (!verifyResult.isVerify) {
        return await next()
    }

    ctx.request.userId = verifyResult.payLoad.userId
    ctx.request.identityInfo = {
        userInfo: verifyResult.payLoad,
        tokenType: 'jwt'
    }

    await next()
}