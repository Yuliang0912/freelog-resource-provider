'use strict'

const fs = require('fs')
const path = require('path')
const is = require('is-type-of')

module.exports = app => {

    const {baseDir, customFileLoader} = app.config
    if (!Array.isArray(customFileLoader) || !customFileLoader.length) {
        return
    }

    customFileLoader.forEach(item => {

        var fullPath = '', isRecursion = false
        if (toString.call(item) === '[object Object]') {
            isRecursion = item.isRecursion
            fullPath = path.join(baseDir, item.dir)
        } else {
            fullPath = path.join(baseDir, item)
        }
        if (fs.statSync(fullPath).isFile()) {
            return loadFile(fullPath)
        } else {
            loadFileFromDir(fullPath, isRecursion)
        }
    })

    function loadFileFromDir(dirPath, isRecursion = false) {
        fs.readdirSync(dirPath).forEach(subFile => {
            const subFullPath = path.join(dirPath, subFile)
            if (fs.statSync(subFullPath).isFile()) {
                loadFile(subFullPath)
            } else if (isRecursion) {
                loadFileFromDir(subFullPath, isRecursion)
            }
        })
    }

    function loadFile(filePath) {
        const exports = require(filePath)
        if (is.class(exports)) {
            return new exports(app)
        }
        if (is.function(exports)) {
            return exports(app)
        } else {
            return exports
        }
    }
}